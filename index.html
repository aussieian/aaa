<html>
<head>
	<title>ScrollVids!</title>

<meta name="viewport" content="width=600, initial-scale=1, maximum-scale=1">

<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- touchSwipe.js modified to support tap and swipe in triggerHandler -->
<script src="jquery.touchSwipe.js"></script> 
<script src="notify.min.js"></script>

<style>

#stream {
	width: 580px;
}

.video { 
	padding: 8px;
	background-color: #eee;
}

.video_overlay {
	/*position: absolute;*/
	z-index: 50;
	background: #000;
    opacity: 0;
    border: 1px solid red;
}

.highlighted {
	border: 4px solid red;
}

</style>


<script>

var players = Array();
var now_playing = null;
var scroll_timer = null;
var top_px_play_min = 0;
var top_px_play_max = 100;
var scroll_timer_freq = 500;

$( document ).ready(function() {
	// init youtube
	initYouTube();
});


function main() {
	addVideo('0xyWnYJ1aUQ');
	addVideo('lGuvd2Z5A5c');
	addVideo('EcOgjrRWx_Q');
	addVideo('OPsgh1NWZnM');
	/*addVideo('WxfZkMm3wcg');
	addVideo('jzJlj19lF3w');
	addVideo('-BrDlrytgm8');
	addVideo('cbJhRsdkJcA');
	addVideo('H-frFpGLI5o');
	addVideo('Xws0XKHXpXg');
	addVideo('JRaakIL-N_s');
	addVideo('alX1mZo5wrU');*/
}

function initYouTube() {
	var tag = document.createElement('script');
	tag.src = "http://www.youtube.com/iframe_api";
	var firstScriptTag = document.getElementsByTagName('script')[0];
	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

function addScrollListener() {

	// scroll listener
	$(window).on('scroll', function() {
		if ( scroll_timer ) { 
			clearTimeout(scroll_timer);
		}
		scroll_timer = setTimeout(onScroll, scroll_timer_freq);
	});
}

function onScroll() {

	//console.log(players);
    var scrollTop = $(this).scrollTop();
    $('.video').each(function() {

        //var topDistance = $(this).offset().top;
        var scrollTop     = $(window).scrollTop();
    	var elementOffset = $(this).offset().top;
    	var distance      = (elementOffset - scrollTop);

        if ((distance < top_px_play_max) && (distance > top_px_play_min)) {

	    	key = $(this).attr("video-key");
	    	if (now_playing != key) {
	    		highlightVideo(key);
	    		playVideo(key);
	    	}
        }

   	});

}

function highlightVideo(key) {
	$(".video").removeClass("highlighted");
	$(".video_overlay." + key).addClass("highlighted");
}

function pausePlayingVideo() {
	// stop current video
	if (now_playing != null) {
		pauseVideo(now_playing);
	}
}

function pauseVideo(key) {
	player = players[key];
	player.pauseVideo();
	console.log("pausing " + key);
	if (now_playing == key) {
		now_playing = null;
	}
}

function playVideo(key) {

	if (players[key] == null) {
		return;
	}

	console.log("playing video " + key);

	pausePlayingVideo();
	player = players[key];
	now_playing = key;
	if (typeof(player.playVideo) == "function") {
		player.playVideo();
	} else {
		now_playing = null;
	}
}

function destroyPlayer(key) {
	
	console.log("Destroying player " + key)
	// pause if it is still playing
	pauseVideo(key);

	// destroy it
	player = players[key];
	if (player != null) {
		player.destroy();
	}
	players[key] = null;
}

function handleClickVideo(key) {

	// pause current video if its now playing
	if (now_playing == key) {
		pauseVideo(key);
	} else {
		// pause playing video and play new one
		console.log("here");
		pausePlayingVideo();
		playVideo(key);
	}
}

// remove it
function handleSwipeLeft(key) {

	$(".video." + key).fadeOut(function() { destroyPlayer(key); onScroll(); });
	$.notify("Tossed. Bye bye", "info");
	
	//setTimeout(onScroll, 1000);
	//onScroll();
}

// watch later
function handleSwipeRight(key) {

	$(".video." + key).fadeOut(function() { destroyPlayer(key); onScroll(); });
	$.notify("Snatched! Watch it later on your feed", "success");
	
	//setTimeout(onScroll, 1000);

	//onScroll();
}

function handleDoubleTap(key) {
	$.notify("Loved!", "success");
}

function addVideo(key) {

	// make div container for iframe
	d = document.createElement("div");
	d.setAttribute("class", "video " + key);
	d.setAttribute("video-key", key);

	// make iframe for video
	f = document.createElement("IFRAME");
	f.id = "video_" + key;
	f.setAttribute("src", "http://www.youtube.com/embed/" + key + "?wmode=opaque&enablejsapi=1&controls=0");
	f.setAttribute("enablejsapi", "1");
	f.setAttribute("frameborder", "0");
	f.style.width = 560+"px"; 
	f.style.height = 315+"px";

	d.appendChild(f);

	stream = document.getElementById("stream");
	stream.appendChild(d);

	// add to list of players
	player = new YT.Player("video_" + key, {
	    events: {
	      'onReady': onPlayerReady,
	      'onStateChange': onPlayerStateChange
	    }
	});

	players[key] = player;

	// add overlay
	addOverlay(key);

	// add swipe
	addOverlayHandlers(key);
}

function addOverlay(key) {

	video_div = $(".video." + key);
	video_iframe = $("#video_" + key);

	// make overlay div
	width = video_iframe.width();
	height = video_iframe.height();

	var div = "<div class='video_overlay " + key + "' video-key='" + key + "' style='width: " + width + "px; height: " + height + "px; margin-top: -" + height + "px'></div>";

	video_div.append(div);
}

function addOverlayHandlers(key) {

	// swipe
	$(".video_overlay." + key).swipe({
		swipe:function(event, direction, distance, duration, fingerCount, fingerData) {
			console.log("You swiped " + direction + " for " + distance + " for " + duration);
			if (direction == "left") {
				handleSwipeLeft(key);
			}
			if (direction == "right") {
				handleSwipeRight(key);
			}
			if (direction == "up") {
				scroll_distance = distance * (2000/duration);
				$('html, body').animate({scrollTop: $(window).scrollTop() + scroll_distance}, 500);
				//handleSwipeUp(key);
			}
			if (direction == "down") {
				scroll_distance = distance * (2000/duration);
				$('html, body').animate({scrollTop: $(window).scrollTop() - scroll_distance}, 500);
				//handleSwipeDown(key);
			}
		},
		tap:function(event, target) {
			handleClickVideo(key);
        },
		doubleTap:function(event, target) {
			handleDoubleTap(key);
		},
		threshold:20
	});

}

function onYouTubeIframeAPIReady() {
	addScrollListener();
	main();
}

function onPlayerReady(event) {
  //event.target.playVideo();
}

function onPlayerStateChange() {
  console.log("my state changed");
}

</script>

</head>

<body>

	<div id="input">
		<input type="text" placeholder="Add a video. Example: youtube.com/watch?v=alX1mZo5wrU" size="64">
	</div>

	<div id="stream">
	</div>


</body>

</html>
